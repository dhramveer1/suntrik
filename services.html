<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Report Damaged Module(s)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--card-bg:#fff;--muted:#6b7280;--accent:#0b74de;--danger:#ff6b6b}
    body{font-family:Inter, Arial, Helvetica, sans-serif;background:#f4f7fb;margin:0;padding:32px;display:flex;justify-content:center}
    .card{width:920px;background:var(--card-bg);padding:24px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,30,0.06)}
    h1{margin:0 0 14px;font-size:28px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    select,input[type="text"],input[type="date"],textarea{width:100%;padding:10px;border:1px solid #e3e7ee;border-radius:8px;box-sizing:border-box;font-size:14px}
    .flex{display:flex;gap:12px}
    .flex > *{flex:1}
    .modules{margin-top:6px}
    .module-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .module-row > input{flex:1;padding:10px;border-radius:8px;border:1px solid #e3e7ee}
    .index{width:30px;text-align:center;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:#f1f6fb;color:#111;border:1px solid #e6eef9}
    .btn-danger{background:var(--danger);color:#fff}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:13px;margin-top:10px}
    .message{margin-top:14px;padding:12px;border-radius:8px}
    .message.success{background:#e6ffef;border:1px solid #b7f0c8;color:#0b662d}
    .message.error{background:#fff0f0;border:1px solid #f2b8b8;color:#7a1b1b}
    .footer-note{font-size:12px;color:var(--muted);margin-top:10px}
    @media (max-width:980px){ .card{width:96%} .module-row{flex-direction:column;align-items:stretch} .index{width:auto;text-align:left} }
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>Report Damaged Module(s)</h1>

    <!-- Replace this with your /exec URL if different -->
    <script>const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyQIPUXIhtJaA3C8rtLPSxFbZvSNtXJH-JBSeI5VFNDjzZU-rfyhbGhhX3k4iySDd0/exec';</script>

    <form id="damageForm" autocomplete="off">
      <label for="site">Choose Site</label>
      <select id="site" required>
        <option value="">-- Select site --</option>
        <option>Tolasar</option>
        <option>Malsar</option>
        <option>Girghichiya</option>
        <option>Sawar</option>
        <option>Billyubas</option>
        <option>Bhojasar</option>
        <option>Nethrana</option>
        <option>Sumeriya</option>
      </select>

      <div class="flex" style="margin-top:12px">
        <div>
          <label for="pallet">Pallet No.</label>
          <input id="pallet" type="text" placeholder="Pallet number (optional)" />
        </div>
        <div>
          <label for="invoice">Invoice No.</label>
          <input id="invoice" type="text" placeholder="Invoice number (optional)" />
        </div>
      </div>

      <label for="receivedDate">Date Received</label>
      <input id="receivedDate" type="date" required />

      <label style="margin-top:12px">Damaged Modules (Serial No. & reason) — up to 10</label>
      <div id="modulesContainer" class="modules"></div>

      <div class="actions">
        <button type="button" id="addRow" class="btn btn-ghost">+ Add module row</button>
        <button type="button" id="removeRow" class="btn btn-danger">− Remove last row</button>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="reset" class="btn btn-ghost">Reset</button>
        <div id="statusArea" style="flex:1"></div>
      </div>

      <div id="messageArea" aria-live="polite"></div>

      <p class="footer-note">Notes: Each filled module row will create a row in the selected Google Sheet with (Site, Module Serial, Reason, Pallet No, Invoice No, Date Received, Submitted At).</p>
    </form>
  </div>

<script>
(function(){
  const MAX_ROWS = 10;
  const modulesContainer = document.getElementById('modulesContainer');
  const addRowBtn = document.getElementById('addRow');
  const removeRowBtn = document.getElementById('removeRow');
  const form = document.getElementById('damageForm');
  const msg = document.getElementById('messageArea');
  const statusArea = document.getElementById('statusArea');

  function createModuleRow(index){
    const wrapper = document.createElement('div');
    wrapper.className = 'module-row';
    wrapper.dataset.index = index;

    const idx = document.createElement('div');
    idx.className = 'index';
    idx.textContent = index;

    const serial = document.createElement('input');
    serial.type = 'text';
    serial.placeholder = 'Serial no.';
    serial.name = `serial_${index}`;
    serial.autocomplete = 'off';

    const reason = document.createElement('input');
    reason.type = 'text';
    reason.placeholder = 'Reason (e.g., glass break)';
    reason.name = `reason_${index}`;
    reason.autocomplete = 'off';

    wrapper.appendChild(idx);
    wrapper.appendChild(serial);
    wrapper.appendChild(reason);
    return wrapper;
  }

  function addRow(){
    const current = modulesContainer.querySelectorAll('.module-row').length;
    if (current >= MAX_ROWS) { showMessage('You can add up to ' + MAX_ROWS + ' module rows only.', 'error'); return; }
    const row = createModuleRow(current + 1);
    modulesContainer.appendChild(row);
  }

  function removeRow(){
    const rows = modulesContainer.querySelectorAll('.module-row');
    if (rows.length === 0) return;
    rows[rows.length - 1].remove();
  }

  function showMessage(txt, type='success'){
    msg.innerHTML = `<div class="message ${type==='error' ? 'error' : 'success'}">${txt}</div>`;
    // auto-hide after 7s
    setTimeout(()=>{ if(msg) msg.innerHTML = ''; }, 7000);
  }

  // init with 1 row
  addRow();

  addRowBtn.addEventListener('click', addRow);
  removeRowBtn.addEventListener('click', removeRow);

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    msg.innerHTML = '';
    statusArea.textContent = '';

    const site = document.getElementById('site').value.trim();
    const pallet = document.getElementById('pallet').value.trim();
    const invoice = document.getElementById('invoice').value.trim();
    const receivedDate = document.getElementById('receivedDate').value;

    if (!site) { showMessage('Please select site.', 'error'); return; }
    if (!receivedDate) { showMessage('Please choose Date Received.', 'error'); return; }

    // collect module rows
    const rows = [];
    document.querySelectorAll('.module-row').forEach(row => {
      const idx = row.dataset.index;
      const s = row.querySelector(`input[name="serial_${idx}"]`).value.trim();
      const r = row.querySelector(`input[name="reason_${idx}"]`).value.trim();
      if (s) rows.push({serial: s, reason: r});
    });

    if (rows.length === 0) { showMessage('Add at least one module serial before submitting.', 'error'); return; }

    const payload = { site, pallet, invoice, receivedDate, modules: rows };

    try {
      // Build FormData to avoid preflight OPTIONS
      const formData = new FormData();
      formData.append('payload', JSON.stringify(payload));

      statusArea.textContent = 'Sending...';

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      });

      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch (e) { json = { status: 'error', msg: text || 'Invalid response' }; }

      if (!res.ok || json.status === 'error') {
        showMessage('Submission failed: ' + (json.msg || ('HTTP ' + res.status)), 'error');
        statusArea.textContent = '';
        console.error('Submit error', res.status, text);
        return;
      }

      showMessage(json.msg || 'Submitted successfully ✔️', 'success');
      statusArea.textContent = '';
      form.reset();
      modulesContainer.innerHTML = '';
      addRow(); // reset to one row
    } catch (err) {
      console.error(err);
      showMessage('Submission failed: ' + (err.message || err), 'error');
      statusArea.textContent = '';
    }
  });

})();
</script>
</body>
</html>
