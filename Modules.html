<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Damage Modules — Site Entry Form</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial, Helvetica, sans-serif; margin:20px; background:#f7f9fb;}
    .container{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.06)}
    h1{margin-top:0}
    label{display:block;margin:8px 0 4px;font-weight:600}
    select,input,textarea{width:100%;padding:8px;border:1px solid #d7dbe0;border-radius:6px;box-sizing:border-box}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .module-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .module-row input{flex:1}
    .small{width:80px}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:#0b74de;color:#fff}
    .btn-ghost{background:#eef3fb}
    .btn-danger{background:#ff6b6b;color:#fff}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:0.9em;color:#666;margin-top:6px}
    .success{background:#e6ffef;border:1px solid #b7f0c8;padding:10px;border-radius:6px;margin-top:10px}
    .error{background:#ffecec;border:1px solid #f5b7b7;padding:10px;border-radius:6px;margin-top:10px;color:#7a1b1b}
  </style>
</head>
<body>
  <div class="container">
    <h1>Report Damaged Module(s)</h1>

    <form id="damageForm">
      <label for="site">Choose Site</label>
      <select id="site" required>
        <option value="">-- Select site --</option>
        <option>Tolasar</option>
        <option>Malsar</option>
        <option>Girghichiya</option>
        <option>Sawar</option>
        <option>Billyubas</option>
        <option>Bhojasar</option>
        <option>Nethrana</option>
        <option>Sumeriya</option>
      </select>

      <label style="margin-top:12px">Pallet No.</label>
      <input id="pallet" placeholder="Pallet number (if any)" />

      <label>Invoice No.</label>
      <input id="invoice" placeholder="Invoice number (if any)" />

      <label>Date Received</label>
      <input id="receivedDate" type="date" required />

      <label style="margin-top:12px">Damaged Modules (Serial No. & reason) — up to 10</label>
      <div id="modulesContainer"></div>

      <div class="actions">
        <button type="button" id="addRow" class="btn btn-ghost">+ Add module row</button>
        <button type="button" id="removeRow" class="btn btn-danger">− Remove last row</button>
      </div>

      <div style="margin-top:14px">
        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="reset" class="btn btn-ghost">Reset</button>
      </div>
    </form>

    <div id="messageArea" aria-live="polite"></div>

    <p class="hint">Notes: Each filled module row will create a row in your selected Google Sheet with (Site, Serial, Reason, Pallet, Invoice, Date Received, Timestamp).</p>
  </div>

<script>
/*
  IMPORTANT: Put your Apps Script web app URL here after deployment:
  Example: const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRo_ZV9OMJRQcZkQeISwqqEnfB3tyvtfTrGURKcDaaQiAg4Eb8qYei_e7wowT-7g0/exec';
*/
const SCRIPT_URL = 'PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE';

const MAX_ROWS = 10;
const modulesContainer = document.getElementById('modulesContainer');
const addRowBtn = document.getElementById('addRow');
const removeRowBtn = document.getElementById('removeRow');
const form = document.getElementById('damageForm');
const msg = document.getElementById('messageArea');

function createModuleRow(index){
  const wrapper = document.createElement('div');
  wrapper.className = 'module-row';
  wrapper.dataset.index = index;

  const serialInput = document.createElement('input');
  serialInput.type = 'text';
  serialInput.placeholder = `Serial no. (row ${index})`;
  serialInput.name = `serial_${index}`;

  const reasonInput = document.createElement('input');
  reasonInput.type = 'text';
  reasonInput.placeholder = 'Reason (e.g., glass break, PID, microcrack...)';
  reasonInput.name = `reason_${index}`;

  const label = document.createElement('div');
  label.style.minWidth = '40px';
  label.style.textAlign = 'center';
  label.style.fontSize = '0.9em';
  label.textContent = index;

  wrapper.appendChild(label);
  wrapper.appendChild(serialInput);
  wrapper.appendChild(reasonInput);

  return wrapper;
}

function addRow(){
  const current = modulesContainer.querySelectorAll('.module-row').length;
  if (current >= MAX_ROWS) {
    showMessage('You can add up to ' + MAX_ROWS + ' module rows only.', 'error');
    return;
  }
  const row = createModuleRow(current + 1);
  modulesContainer.appendChild(row);
}

function removeRow(){
  const rows = modulesContainer.querySelectorAll('.module-row');
  if (rows.length === 0) return;
  rows[rows.length - 1].remove();
}

// initialize with 1 row
addRow();

addRowBtn.addEventListener('click', addRow);
removeRowBtn.addEventListener('click', removeRow);

function showMessage(txt, type='success'){
  msg.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${txt}</div>`;
  setTimeout(()=>{ if(msg) msg.innerHTML = ''; }, 7000);
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.innerHTML = '';

  const site = document.getElementById('site').value.trim();
  const pallet = document.getElementById('pallet').value.trim();
  const invoice = document.getElementById('invoice').value.trim();
  const receivedDate = document.getElementById('receivedDate').value;

  if (!site) { showMessage('Please select site.', 'error'); return; }
  if (!receivedDate) { showMessage('Please select date received.', 'error'); return; }

  // collect module rows
  const rows = [];
  document.querySelectorAll('.module-row').forEach(row => {
    const idx = row.dataset.index;
    const serial = row.querySelector(`input[name="serial_${idx}"]`).value.trim();
    const reason = row.querySelector(`input[name="reason_${idx}"]`).value.trim();
    if (serial) {
      rows.push({serial, reason});
    }
  });

  if (rows.length === 0) { showMessage('Please add at least one module serial.', 'error'); return; }

  // payload structure
  const payload = {
    site,
    pallet,
    invoice,
    receivedDate,
    modules: rows
  };

  // send to Apps Script
  try {
    showMessage('Sending data...', 'success');
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text || 'Request failed');

    showMessage('Submitted successfully ✔️');
    form.reset();
    modulesContainer.innerHTML = '';
    addRow(); // reset to 1 row
  } catch (err) {
    console.error(err);
    showMessage('Submission failed: ' + (err.message || err), 'error');
  }
});
</script>
</body>
</html>

