<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Damage Module Receipt Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --glass:rgba(0,0,0,0.03);
      --text-main:#111827; --text-muted:#4b5563; --text-heading:#1e3a8a;
      --accent:#2563eb; --accent-2:#7c3aed; --success:#15803d; --danger:#dc2626;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f7f9fc 0%,var(--bg) 100%);color:var(--text-main);margin:24px}
    .wrap{max-width:980px;margin:18px auto;padding:18px;animation:fadeIn .6s ease both}
    .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 10px 30px rgba(16,24,40,0.08);border:1px solid rgba(0,0,0,0.04);transform-origin:center;transition:transform .28s ease}
    .card:hover{transform:translateY(-6px)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    label{display:block;font-weight:700;margin-top:12px;color:var(--text-heading);font-size:14px}
    select,input[type=text],input[type=date],textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:var(--text-main);margin-top:6px;transition:box-shadow .18s ease,transform .12s ease}
    select:focus,input[type=text]:focus,input[type=date]:focus,textarea:focus{box-shadow:0 6px 18px rgba(37,99,235,0.08);transform:translateY(-1px);outline:none;border-color:rgba(37,99,235,0.35)}
    .row-item{display:flex;gap:10px;align-items:center;margin-bottom:8px;background:var(--glass);padding:8px;border-radius:8px}
    .row-item input[type=text]{flex:1;min-width:140px}
    .row-item select{width:220px}
    .row-item .btn-del{background:transparent;border:0;color:var(--danger);padding:6px;border-radius:6px;cursor:pointer;font-size:18px}
    .controls{display:flex;gap:10px;margin-top:10px;align-items:center}
    .btn{cursor:pointer;padding:10px 14px;border-radius:10px;border:0;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 6px 18px rgba(37,99,235,0.14);transition:transform .12s ease}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{background:#f9fafb;color:var(--text-main);border:1px solid rgba(0,0,0,0.06)}
    .btn-disabled{opacity:0.35;pointer-events:none}
    .info{margin-top:6px;color:var(--text-muted);font-size:13px}
    .flex{display:flex;gap:12px}
    .flex .col{flex:1}
    .message{margin-top:12px}
    .msg{padding:10px;border-radius:8px}
    .msg.success{background:rgba(22,163,74,0.08);color:var(--success)}
    .msg.error{background:rgba(220,38,38,0.08);color:var(--danger)}
    .small{width:180px;padding:8px}
    @media (max-width:720px){ .row-item{flex-direction:column;align-items:stretch} .row-item select{width:100%} }
    #addRow{animation:shine 4s linear infinite}
    @keyframes shine{0%{filter:brightness(1)}50%{filter:brightness(1.02)}100%{filter:brightness(1)}}
    .meta{font-size:13px;color:var(--text-muted)}
    .submitted-banner{margin-top:16px;padding:18px;border-radius:12px;background:linear-gradient(90deg, rgba(21,128,61,0.07), rgba(37,99,235,0.03));display:flex;flex-direction:column;gap:10px;align-items:flex-start}
    .submitted-banner h2{margin:0;color:var(--success);font-size:20px}
    .inline-muted{color:var(--text-muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-label="Damage module receipt form">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px">DM</div>
        <div>
          <div style="font-weight:800;color:var(--text-heading);font-size:18px">Damage Module Receipt</div>
          <div style="font-size:13px;color:var(--text-muted)">Record broken/damaged PV modules received on site</div>
        </div>
      </div>

      <form id="damageForm" autocomplete="off">
        <label for="site">1) Choose Site (sheet)</label>
        <select id="site" name="site" required>
          <option value="">-- Select site --</option>
          <option>Tolasar</option><option>Malsar</option><option>Girghichiya</option><option>Sawar</option><option>Billyubas</option><option>Bhojasar</option><option>Nethrana</option><option>Sumeriya</option>
        </select>
        <div class="info">Choose the sheet name that corresponds to the site (the Google Sheet must have a tab with the same name). If tab does not exist, the script will create it automatically.</div>

        <label class="rows">2) Module serial numbers &amp; reason (max 10 rows)</label>
        <div id="rowsContainer" aria-live="polite"></div>

        <div class="controls">
          <button type="button" id="addRow" class="btn btn-ghost" aria-label="Add row">+ Add row</button>
          <button type="button" id="removeRow" class="btn btn-ghost" aria-label="Remove last row">− Remove last</button>
          <div style="margin-left:auto;color:var(--text-muted);" class="meta">Rows: <strong id="rowCount">0</strong>/10</div>
        </div>

        <label for="pallet">3) Pallet No. (from which broken modules received)</label>
        <input id="pallet" name="pallet" type="text" placeholder="e.g. PLT-2025-001" required>

        <label for="invoice">4) Invoice / Delivery Challan No. (pallet)</label>
        <input id="invoice" name="invoice" type="text" placeholder="e.g. INV-45987" required>

        <div class="flex">
          <div class="col">
            <label for="receivedDate">5) Date of received modules</label>
            <input id="receivedDate" name="receivedDate" type="date" required>
            <div class="info">Select the exact date the pallet arrived on site.</div>
          </div>
          <div class="col">
            <label for="inspectedBy">Inspected by (site engineer)</label>
            <input id="inspectedBy" name="inspectedBy" type="text" placeholder="Site Engineer name" required>
          </div>
        </div>

        <label for="notes">Additional notes (optional)</label>
        <textarea id="notes" name="notes" rows="3" placeholder="e.g. packaging damaged, photos attached, etc."></textarea>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
          <button type="submit" id="submitBtn" class="btn btn-primary">Submit to Sheet</button>
          <button type="button" id="resetBtn" class="btn btn-ghost">Reset</button>
        </div>

        <div id="messageArea" class="message" aria-live="polite"></div>
      </form>

      <!-- shown after success -->
      <div id="submittedArea" style="display:none">
        <div class="submitted-banner" role="status" aria-live="polite">
          <h2 id="submittedTitle">Data submitted successfully</h2>
          <div id="submittedDetails" class="inline-muted">Your entries have been recorded to the selected sheet.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="addMoreBtn" class="btn btn-ghost">Add more modules</button>
            <button id="viewSheetBtn" class="btn btn-ghost">Open sheet (in new tab)</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // *** CONFIG: set your deployed Apps Script web app URL here (replace) ***
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbEhqL1eLnRky2cjAIvUn6E38UaJh4yG67KRJ1cOJMBnKo4_gTzqOHIJMTOHURH-4f/exec';

    // localStorage key
    const STORAGE_KEY = 'dm_form_state_v1';

    const MAX_ROWS = 10;
    const rowsContainer = document.getElementById('rowsContainer');
    const rowCountEl = document.getElementById('rowCount');
    const addRowBtn = document.getElementById('addRow');
    const removeRowBtn = document.getElementById('removeRow');
    const submitBtn = document.getElementById('submitBtn');
    const messageArea = document.getElementById('messageArea');
    const submittedArea = document.getElementById('submittedArea');
    const addMoreBtn = document.getElementById('addMoreBtn');
    const viewSheetBtn = document.getElementById('viewSheetBtn');

    // create a row element
    function createRow(index, data={serial:'', reason:'', other:''}) {
      const wrap = document.createElement('div');
      wrap.className = 'row-item';
      wrap.dataset.index = index;

      const sn = document.createElement('input');
      sn.type = 'text';
      sn.name = `serial_${index}`;
      sn.placeholder = 'Module Serial No.';
      sn.required = true;
      sn.value = data.serial || '';

      const reason = document.createElement('select');
      reason.name = `reason_${index}`;
      reason.required = true;
      reason.innerHTML = `
        <option value="">-- Reason --</option>
        <option>Glass break</option>
        <option>Cell damage</option>
        <option>Junction box</option>
        <option>Frame bend</option>
        <option>Shipping / Handling</option>
        <option>Other</option>
      `;
      if (data.reason) reason.value = data.reason;

      const otherText = document.createElement('input');
      otherText.type = 'text';
      otherText.name = `other_${index}`;
      otherText.placeholder = 'If Other, describe...';
      otherText.className = 'small';
      otherText.value = data.other || '';

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'btn-del';
      delBtn.title = 'Delete this row';
      delBtn.innerHTML = '✕';
      delBtn.addEventListener('click', ()=>{
        // If only one row left => clear it instead of removing node
        if (rowsContainer.children.length <= 1) {
          clearRowInputs(wrap);
          saveState();
          return;
        }
        rowsContainer.removeChild(wrap);
        reindexRows();
        updateRowCount();
        saveState();
      });

      // Save on input
      [sn, reason, otherText].forEach(el => el.addEventListener('input', saveState));
      reason.addEventListener('change', ()=>{
        otherText.style.display = (reason.value === 'Other') ? 'inline-block' : 'none';
        if(reason.value !== 'Other') otherText.value = '';
      });
      otherText.style.display = (data.reason === 'Other') ? 'inline-block' : 'none';

      wrap.appendChild(sn);
      wrap.appendChild(reason);
      wrap.appendChild(otherText);
      wrap.appendChild(delBtn);

      return wrap;
    }

    function clearRowInputs(row){
      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(i => {
        if (i.tagName === 'INPUT') i.value = '';
        else if (i.tagName === 'SELECT') i.value = '';
      });
    }

    // Reindex rows so names remain sequential and predictable
    function reindexRows(){
      Array.from(rowsContainer.children).forEach((row, i) => {
        const newIndex = i + 1;
        row.dataset.index = newIndex;
        const sn = row.querySelector('input[name^="serial_"]');
        const other = row.querySelector('input[name^="other_"]');
        const reason = row.querySelector('select[name^="reason_"]');
        if (sn) sn.name = `serial_${newIndex}`;
        if (reason) reason.name = `reason_${newIndex}`;
        if (other) other.name = `other_${newIndex}`;
      });
    }

    function updateRowCount() {
      const count = rowsContainer.children.length;
      rowCountEl.textContent = count;
      removeRowBtn.style.display = (count <= 1) ? 'none' : 'inline-block';
      if (count >= MAX_ROWS) {
        addRowBtn.classList.add('btn-disabled');
        addRowBtn.disabled = true;
      } else {
        addRowBtn.classList.remove('btn-disabled');
        addRowBtn.disabled = false;
      }
      Array.from(rowsContainer.children).forEach(r=>{
        const del = r.querySelector('.btn-del');
        if (del) del.style.display = (rowsContainer.children.length <= 1) ? 'none' : 'inline-block';
      });
    }

    addRowBtn.addEventListener('click', ()=>{
      const count = rowsContainer.children.length;
      if (count >= MAX_ROWS) return;
      const idx = count + 1;
      rowsContainer.appendChild(createRow(idx));
      reindexRows();
      updateRowCount();
      saveState();
      // focus new serial
      const newRow = rowsContainer.lastElementChild;
      newRow.querySelector(`input[name="serial_${idx}"]`)?.focus();
    });

    removeRowBtn.addEventListener('click', ()=>{
      const count = rowsContainer.children.length;
      if (count <= 1) {
        // clear the only row instead of removing node
        const only = rowsContainer.firstElementChild;
        if (only) clearRowInputs(only);
        saveState();
        return;
      }
      rowsContainer.removeChild(rowsContainer.lastElementChild);
      reindexRows();
      updateRowCount();
      saveState();
    });

    // Save whole form state (rows + main fields) to localStorage
    function saveState(){
      try {
        const rows = Array.from(rowsContainer.children).map((r, i)=>{
          const idx = r.dataset.index || (i+1);
          return {
            serial: r.querySelector(`input[name=serial_${idx}]`)?.value || '',
            reason: r.querySelector(`select[name=reason_${idx}]`)?.value || '',
            other: r.querySelector(`input[name=other_${idx}]`)?.value || ''
          };
        });
        const state = {
          site: document.getElementById('site').value,
          pallet: document.getElementById('pallet').value,
          invoice: document.getElementById('invoice').value,
          receivedDate: document.getElementById('receivedDate').value,
          inspectedBy: document.getElementById('inspectedBy').value,
          notes: document.getElementById('notes').value,
          rows
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (err) {
        console.warn('Save state failed', err);
      }
    }

    // Restore saved state
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) {
        rowsContainer.appendChild(createRow(1));
        reindexRows();
        updateRowCount();
        return;
      }
      try {
        const state = JSON.parse(raw);
        if(state.site) document.getElementById('site').value = state.site;
        if(state.pallet) document.getElementById('pallet').value = state.pallet;
        if(state.invoice) document.getElementById('invoice').value = state.invoice;
        if(state.receivedDate) document.getElementById('receivedDate').value = state.receivedDate;
        if(state.inspectedBy) document.getElementById('inspectedBy').value = state.inspectedBy;
        if(state.notes) document.getElementById('notes').value = state.notes;

        const rows = (state.rows && state.rows.length) ? state.rows : [{serial:'',reason:'',other:''}];
        rows.forEach((r,i)=>{
          rowsContainer.appendChild(createRow(i+1, r));
        });
        if (rowsContainer.children.length === 0) rowsContainer.appendChild(createRow(1));
        reindexRows();
        updateRowCount();
      } catch (err) {
        console.warn('Load state failed', err);
        rowsContainer.appendChild(createRow(1));
        reindexRows();
        updateRowCount();
      }
    }

    // Attach change listeners on main fields to save
    ['site','pallet','invoice','receivedDate','inspectedBy','notes'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', saveState);
    });

    // Initialize
    loadState();

    // Disable form inputs (used after success)
    function disableForm(){
      Array.from(document.querySelectorAll('#damageForm input, #damageForm select, #damageForm textarea, #damageForm button'))
        .forEach(el=> el.disabled = true);
      // hide message area and form submit controls remain disabled
    }

    // Re-enable form inputs
    function enableForm(){
      Array.from(document.querySelectorAll('#damageForm input, #damageForm select, #damageForm textarea, #damageForm button'))
        .forEach(el=> el.disabled = false);
      // keep Add/Remove/Submit re-enabled by updateRowCount
      updateRowCount();
    }

    // Show submission success UI: disable inputs and show banner
    function showSubmissionUI(sheetUrl){
      disableForm();
      document.getElementById('submittedTitle').textContent = 'Data submitted successfully';
      const details = document.getElementById('submittedDetails');
      details.textContent = 'Your entries have been recorded to the selected sheet.';
      if(sheetUrl) viewSheetBtn.dataset.url = sheetUrl;
      submittedArea.style.display = 'block';
      // scroll into view
      submittedArea.scrollIntoView({behavior:'smooth'});
    }

    // Re-enable to add more modules: keep selected site/pallet/invoice as is, reset rows
    addMoreBtn.addEventListener('click', ()=>{
      // hide banner
      submittedArea.style.display = 'none';
      // clear module rows but keep site/pallet/invoice/others (optional)
      while(rowsContainer.firstChild) rowsContainer.removeChild(rowsContainer.firstChild);
      rowsContainer.appendChild(createRow(1));
      reindexRows();
      updateRowCount();
      enableForm();
      saveState();
      // focus first serial
      rowsContainer.firstElementChild.querySelector('input')?.focus();
    });

    // open sheet url (if backend returned it)
    viewSheetBtn.addEventListener('click', ()=>{
      const url = viewSheetBtn.dataset.url;
      if(url) window.open(url, '_blank');
      else showMessage('Sheet URL not available','error');
    });

    // Submit handler
    document.getElementById('damageForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const form = e.target;
      const site = form.site.value;
      if(!site){ return showMessage('Please select a site','error') }
      const rows = [];
      for(let i=0;i<rowsContainer.children.length;i++){
        const r = rowsContainer.children[i];
        const idx = r.dataset.index || (i+1);
        const serialEl = r.querySelector(`input[name=serial_${idx}]`);
        const reasonEl = r.querySelector(`select[name=reason_${idx}]`);
        const otherEl = r.querySelector(`input[name=other_${idx}]`);
        const serial = (serialEl && serialEl.value) ? serialEl.value.trim() : '';
        const reason = (reasonEl && reasonEl.value) ? reasonEl.value : '';
        const other = (otherEl && otherEl.value) ? otherEl.value.trim() : '';
        if(!serial){ return showMessage('Please fill all module serial numbers','error') }
        if(!reason){ return showMessage('Please select reason for each module','error') }
        rows.push({serial, reason: reason === 'Other' ? (other || 'Other') : reason});
      }
      const payload = {
        site,
        pallet: form.pallet.value.trim(),
        invoice: form.invoice.value.trim(),
        receivedDate: form.receivedDate.value,
        inspectedBy: form.inspectedBy.value.trim(),
        notes: form.notes.value.trim(),
        modules: rows
      };

      try {
        if(!payload.pallet || !payload.invoice || !payload.receivedDate || !payload.inspectedBy){
          return showMessage('Please fill all required fields','error');
        }
        showMessage('Submitting...','');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const res = await fetch(APPS_SCRIPT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch(e){ json = null; }

        if(!res.ok){
          const msg = (json && json.error) ? json.error : (text || `HTTP ${res.status}`);
          throw new Error(msg);
        }

        // success JSON expected { success:true, sheetUrl: '...' }
        showMessage('Submitted successfully','success');
        // optionally show sheet URL returned by backend
        const sheetUrl = json && json.sheetUrl ? json.sheetUrl : null;
        showSubmissionUI(sheetUrl);

        // clear localStorage so reload starts fresh (we keep site/pallet/invoice fields enabled only after add-more)
        localStorage.removeItem(STORAGE_KEY);

      } catch(err) {
        console.error(err);
        showMessage('Submission failed: '+err.message,'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit to Sheet';
      }
    });

    function showMessage(text,type){
      messageArea.innerHTML='';
      if(!text) return;
      const div=document.createElement('div');
      div.className='msg '+(type==='success'?'success':type==='error'?'error':'');
      div.textContent=text;
      messageArea.appendChild(div);
      setTimeout(()=>{ if(messageArea) messageArea.innerHTML=''; },4000);
    }

    // Reset button clears localStorage too
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      document.getElementById('damageForm').reset();
      while(rowsContainer.firstChild) rowsContainer.removeChild(rowsContainer.firstChild);
      rowsContainer.appendChild(createRow(1));
      reindexRows();
      updateRowCount();
      localStorage.removeItem(STORAGE_KEY);
      showMessage('Form reset','');
    });

    // Save state before page unload (extra safety)
    window.addEventListener('beforeunload', saveState);
  </script>
</body>
</html>
