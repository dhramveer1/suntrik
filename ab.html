<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Module Receiving — Site Entry Form</title>
  <style>
    :root{--navy:#0b2340;--accent:#1f6feb;--bg:#f8fafc;--card:#fff;--muted:#6b7178;--text:#0f1724;--radius:10px;--shadow:0 6px 18px rgba(11,35,64,0.06)}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); margin:18px}
    .container{max-width:1100px;margin:0 auto}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);}
    h1{margin:0 0 8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea,button{font-size:14px}
    .row{display:flex;gap:12px;align-items:end}
    .col{flex:1}
    .col-small{flex:0 0 160px}
    input[type=text], input[type=date], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;background:transparent}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left}
    thead th{background:linear-gradient(90deg,var(--navy),var(--accent));color:#fff}
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:9px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #e6e9ee}
    .muted{color:var(--muted)}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header style="margin-bottom:12px">
      <h1>Module Receiving — Site Entry</h1>
      <div class="muted">Site engineers can add up to 10 module serials per submission. Data will be sent to the sheet tab matching the chosen site.</div>
    </header>

    <section class="card">
      <form id="mainForm" autocomplete="off">
        <div class="row">
          <div class="col-small">
            <label for="site">Site</label>
            <select id="site" name="site" required>
              <option value="">-- Select site --</option>
              <option>Tolasar</option>
              <option>Malsar</option>
              <option>Girghichiya</option>
              <option>Sawar</option>
              <option>Billyubas</option>
              <option>Bhojasar</option>
              <option>Nethrana</option>
              <option>Sumeriya</option>
            </select>
          </div>

          <div class="col">
            <label for="palletNo">Pallet No.</label>
            <input id="palletNo" name="palletNo" placeholder="e.g. P-1234" />
          </div>

          <div class="col">
            <label for="invoiceNo">Invoice No.</label>
            <input id="invoiceNo" name="invoiceNo" placeholder="e.g. INV-789" />
          </div>

          <div class="col-small">
            <label for="receivedDate">Date Received</label>
            <input type="date" id="receivedDate" name="receivedDate" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Modules (up to 10)</label>
          <table id="modulesTable">
            <thead>
              <tr>
                <th style="width:48px">#</th>
                <th>Module Serial No.</th>
                <th>Damage Reason / What is broken</th>
                <th style="width:100px">Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows inserted here -->
            </tbody>
          </table>

          <div class="actions">
            <button type="button" id="addRow" class="btn btn-ghost">Add Row</button>
            <button type="button" id="removeRow" class="btn btn-ghost">Remove Last</button>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button type="button" id="saveLocal" class="btn">Save Locally</button>
              <button type="submit" id="submitBtn" class="btn btn-primary">Submit to Sheet</button>
            </div>
          </div>

          <div class="note">Tip: Use <strong>Add Row</strong> to add module serial inputs (max 10). Each module can have its own damage reason.</div>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Preview / Queue</h3>
      <div id="preview" class="muted">No submissions yet. After submit, each module will be added as a row in the selected sheet/tab.</div>
    </section>

  </div>

<script>
(function(){
  const MAX = 10;
  const tbody = document.querySelector('#modulesTable tbody');
  const addRowBtn = document.getElementById('addRow');
  const removeRowBtn = document.getElementById('removeRow');
  const form = document.getElementById('mainForm');
  const preview = document.getElementById('preview');
  const saveLocalBtn = document.getElementById('saveLocal');

  // replace this with your Apps Script Web App URL after deploying the script
  // e.g. const WEBAPP_URL = '';
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbz742jgC8J81v3othRfeMDPGh7hRe0Qvfvg_G1VpxfEFktoy_3B3WplXurUm8jYd2hY8w/exec';

  // initialize with one row
  function createRow(index, data={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="center">${index}</td>
      <td><input type="text" name="moduleSn" placeholder="Module SN" value="${data.moduleSn||''}" /></td>
      <td><input type="text" name="damageReason" placeholder="Glass broken, Junction box, Frame, etc" value="${data.damageReason||''}" /></td>
      <td><button type="button" class="btn btn-ghost small" data-action="remove">Delete</button></td>
    `;
    tbody.appendChild(tr);
  }

  function reindex(){
    Array.from(tbody.querySelectorAll('tr')).forEach((tr,i)=> tr.cells[0].textContent = i+1);
  }

  function addRow(){
    const current = tbody.querySelectorAll('tr').length;
    if(current >= MAX){ alert('Maximum '+MAX+' rows reached'); return; }
    createRow(current+1);
  }

  function removeLast(){
    const rows = tbody.querySelectorAll('tr');
    if(rows.length === 0) return;
    rows[rows.length-1].remove();
  }

  addRowBtn.addEventListener('click', addRow);
  removeRowBtn.addEventListener('click', ()=>{ removeLast(); reindex(); });

  tbody.addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    if(btn.dataset.action === 'remove'){
      btn.closest('tr').remove(); reindex();
    }
  });

  // add initial row
  addRow();

  // collect rows as array of objects
  function collectRows(){
    const rows = [];
    Array.from(tbody.querySelectorAll('tr')).forEach((tr,i)=>{
      const sn = (tr.querySelector('input[name="moduleSn"]')||{}).value?.trim();
      const dmg = (tr.querySelector('input[name="damageReason"]')||{}).value?.trim();
      if(sn) rows.push({moduleSn: sn, damageReason: dmg});
    });
    return rows;
  }

  function updatePreview(text){ preview.textContent = text; }

  // Local save (localStorage) — useful when offline
  saveLocalBtn.addEventListener('click', ()=>{
    const payload = buildPayload();
    if(!payload) return;
    const key = 'module_receiver_draft';
    localStorage.setItem(key, JSON.stringify(payload));
    alert('Saved locally in browser');
  });

  function buildPayload(){
    const site = document.getElementById('site').value;
    if(!site){ alert('Please select site'); return null; }
    const palletNo = document.getElementById('palletNo').value.trim();
    const invoiceNo = document.getElementById('invoiceNo').value.trim();
    const receivedDate = document.getElementById('receivedDate').value || '';
    const modules = collectRows();
    if(modules.length === 0){ alert('Add at least one module with serial number'); return null; }
    // prepare payload: site + common pallet/invoice/date + modules array
    return { site, palletNo, invoiceNo, receivedDate, modules };
  }

  // submit handler: sends payload to Apps Script; Apps Script will append rows to sheet named == site
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = buildPayload();
    if(!payload) return;

    // quick preview
    updatePreview('Submitting '+payload.modules.length+' module(s) to sheet: '+payload.site+' ...');

    if(WEBAPP_URL === 'YOUR_WEBAPP_URL'){
      alert('Please replace the placeholder WEBAPP_URL in the HTML with your deployed Apps Script Web App URL before submitting.');
      updatePreview('Submission blocked: WEBAPP_URL placeholder not replaced.');
      return;
    }

    try{
      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if(json.result === 'success'){
        updatePreview('Success: '+json.message || 'Data saved');
        alert('Saved to Google Sheet ✅');
        form.reset(); tbody.innerHTML=''; addRow();
      } else {
        updatePreview('Server error: '+(json.message || JSON.stringify(json)));
        alert('Server error: '+(json.message || 'see preview'));
      }
    } catch(err){
      console.error(err);
      updatePreview('Network/CORS error: '+err.message);
      alert('Network error. Check console and ensure Apps Script is deployed with proper permissions and CORS headers.');
    }
  });

  // helper: show saved draft on load
  (function loadDraft(){
    const key = 'module_receiver_draft';
    const raw = localStorage.getItem(key);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      document.getElementById('site').value = d.site || '';
      document.getElementById('palletNo').value = d.palletNo || '';
      document.getElementById('invoiceNo').value = d.invoiceNo || '';
      document.getElementById('receivedDate').value = d.receivedDate || '';
      tbody.innerHTML = '';
      (d.modules||[]).slice(0,MAX).forEach((m,i)=> createRow(i+1,m));
      reindex();
      updatePreview('Loaded draft with '+(d.modules||[]).length+' module(s)');
    }catch(e){/*ignore*/}
  })();

})();
</script>

<!--
  === APPS SCRIPT: Deploy this to handle incoming submissions and write to sheet tabs ===

  1) In your Google Spreadsheet: Extensions -> Apps Script
  2) Create a new script file and paste the code below. Replace SPREADSHEET_ID.
  3) Deploy -> New deployment -> Web app. Execute as: Me. Who has access: Anyone, even anonymous.
  4) Copy the Web App URL and paste it into the WEBAPP_URL constant in the HTML above.

  Paste this Apps Script code in Code.gs:

  s
</body>
</html>
